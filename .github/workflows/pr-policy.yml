name: PR Policy

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  policy:
    runs-on: ubuntu-latest
    outputs:
      agent_id: ${{ steps.validate.outputs.agent_id }}
      agent_label: ${{ steps.validate.outputs.agent_label }}
    steps:
      - name: Validate branch and scope ownership
        id: validate
        uses: actions/github-script@v7
        with:
          script: |
            const headRef = context.payload.pull_request.head.ref;
            const branchMatch = headRef.match(/^agent([1-4])\/[A-Za-z0-9._-]+$/);

            if (!branchMatch) {
              core.setFailed(
                `Invalid branch name "${headRef}". Expected format: agent1/<name> .. agent4/<name>.`
              );
              return;
            }

            const agentId = branchMatch[1];
            const agentLabel = `agent:${agentId}`;
            core.setOutput("agent_id", agentId);
            core.setOutput("agent_label", agentLabel);

            const ownerRules = {
              "1": [
                /^index\.html$/,
                /^docs\/agent-status\.md$/
              ],
              "2": [
                /^styles\.css$/,
                /^docs\/agent-status\.md$/
              ],
              "3": [
                /^app\.js$/,
                /^docs\/agent-status\.md$/
              ],
              "4": [
                /^\.github\/workflows\/.+$/,
                /^docs\/.+$/
              ]
            };

            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                per_page: 100
              }
            );

            const invalidFiles = [];
            const rules = ownerRules[agentId] || [];

            for (const file of files) {
              const inScope = rules.some((rule) => rule.test(file.filename));
              if (!inScope) {
                invalidFiles.push(file.filename);
              }
            }

            if (invalidFiles.length > 0) {
              core.setFailed(
                [
                  `Branch owner ${agentLabel} touched out-of-scope files:`,
                  ...invalidFiles.map((path) => `- ${path}`)
                ].join("\n")
              );
              return;
            }

            core.info(
              `Policy check passed for ${agentLabel}. ${files.length} changed file(s) are in scope.`
            );

  coordinator_assignment_stub:
    needs: policy
    if: ${{ success() && !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger coordinator assignment stub
        uses: actions/github-script@v7
        with:
          script: |
            const marker = "<!-- coordinator-assignment-stub -->";
            const body = [
              marker,
              `Coordinator assignment trigger stub: policy passed for \`${{ needs.policy.outputs.agent_label }}\`.`,
              "Main agent should assign reviewer/merge order based on current round status."
            ].join("\n");

            const comments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                per_page: 100
              }
            );

            const alreadyPosted = comments.some((comment) => comment.body && comment.body.includes(marker));
            if (alreadyPosted) {
              core.info("Coordinator assignment stub comment already exists.");
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

            core.info("Coordinator assignment stub comment posted.");
